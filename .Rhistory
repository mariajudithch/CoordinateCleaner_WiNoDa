install.packages(c(
"CoordinateCleaner",
"countrycode",
"dplyr",
"ggplot2",
"rgbif",
"sf",
"tibble",
"readr"
))
library(CoordinateCleaner)
library(countrycode)
library(dplyr)
library(ggplot2)
library(rgbif)
library(sf)
library(tibble)
library(readr)
# Download herbarium records from GBIF using 'rgbif'
# We use three institutions as an example: COL, HUA, MO
herbaria <- c("COL", "HUA", "MO")
gbif_list <- lapply(herbaria, function(inst) {
message("Downloading records for institutionCode = ", inst)
res <- occ_search(
institutionCode = inst,
hasCoordinate   = TRUE,
limit           = 5000
)
res$data
})
# Combine all downloaded records into one table
dat_raw <- dplyr::bind_rows(gbif_list)
# Inspect structure
str(dat_raw)
# Save a local copy so participants can load it without downloading
if (!dir.exists("data")) dir.create("data")
readr::write_csv(dat_raw, "data/herbaria_raw_epiphytes.csv")
dat <- dat_raw %>%
select(
species,
decimalLongitude,
decimalLatitude,
countryCode,
year,
basisOfRecord,
coordinateUncertaintyInMeters,
individualCount,
institutionCode,
datasetName,
gbifID
) %>%
filter(!is.na(decimalLongitude), !is.na(decimalLatitude)) %>%
filter(basisOfRecord == "PRESERVED_SPECIMEN") %>%
rename(lon = decimalLongitude, lat = decimalLatitude)
View(dat_raw)
names(dat_raw)
glimpse(dat)
dat <- dat_raw %>%
dplyr::select(
species,
decimalLongitude,
decimalLatitude,
countryCode,
year,
basisOfRecord,
individualCount,
institutionCode,
datasetName,
gbifID
) %>%
dplyr::filter(!is.na(decimalLongitude),
!is.na(decimalLatitude)) %>%
dplyr::filter(basisOfRecord == "PRESERVED_SPECIMEN") %>%
dplyr::rename(lon = decimalLongitude,
lat = decimalLatitude)
glimpse(dat)
# number of records
nrow(dat_raw)
# names of all columns
names(dat_raw)
# quick preview
head(dat_raw)
# number of cleaned records
nrow(dat)
# structure of the filtered data
str(dat)
# basic summary of coordinate ranges
summary(dat[, c("lon", "lat")])
# number of records
nrow(dat_raw)
# names of all columns
names(dat_raw)
# quick preview
head(dat_raw)
# number of records
nrow(dat_raw)
# names of all columns
names(dat_raw)
# quick preview
head(dat_raw)
world_map <- borders("world", colour = "gray70", fill = "gray90")
ggplot() +
world_map +
coord_fixed() +
geom_point(
data = dat,
aes(x = lon, y = lat, colour = institutionCode),
size = 0.7,
alpha = 0.7
) +
labs(
title = "Raw herbarium records from GBIF",
subtitle = "Colour indicates institutionCode",
x = "Longitude",
y = "Latitude"
) +
theme_bw()
plot_flags <- function(data, flag, title) {
data_flagged <- data[!flag, ]
data_kept    <- data[flag, ]
ggplot() +
world_map +
coord_fixed() +
geom_point(
data = data_kept,
aes(x = lon, y = lat),
color = "darkgreen",
size = 0.6,
alpha = 0.7
) +
geom_point(
data = data_flagged,
aes(x = lon, y = lat),
color = "red",
size = 0.8,
alpha = 0.8
) +
labs(
title = title,
subtitle = "Green = kept, Red = flagged",
x = "Longitude",
y = "Latitude"
) +
theme_bw()
}
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
verbose = FALSE
)
table(flag_val)
plot_flags <- function(data, flag, title) {
data_flagged <- data[!flag, ]
data_kept    <- data[flag, ]
world_map <- borders("world", colour = "gray70", fill = "gray90")
ggplot() +
world_map +
coord_fixed() +
geom_point(
data = data_kept,
aes(lon, lat),
color = "darkgreen",
size = 0.6,
alpha = 0.7
) +
geom_point(
data = data_flagged,
aes(lon, lat),
color = "red",
size = 0.8,
alpha = 0.8
) +
labs(
title = title,
subtitle = "Green = kept, Red = flagged"
) +
theme_bw()
}
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
verbose = FALSE
)
table(flag_val)
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
verbose = FALSE
)
# how many records are kept vs flagged
n_total   <- length(flag_val)
n_kept    <- sum(flag_val, na.rm = TRUE)
flag_val
# how many records are kept vs flagged
n_total   <- length(flag_val)
n_kept    <- sum(flag_val, na.rm = TRUE)
n_flagged <- n_total - n_kept
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
verbose = FALSE
)
# ensure 'flag_val' is a logical vector, not a data.frame
if (is.data.frame(flag_val) || inherits(flag_val, "tbl_df")) {
flag_val <- flag_val[[1]]
}
flag_val <- as.logical(flag_val)
# how many records are kept vs flagged
n_total   <- length(flag_val)
n_kept    <- sum(flag_val, na.rm = TRUE)
n_flagged <- n_total - n_kept
cat("Total records:", n_total, "\n")
cat("Kept (valid coordinates):", n_kept, "\n")
cat("Flagged (invalid coordinates):", n_flagged, "\n")
plot_flags(dat, flag_val, "Invalid coordinates flagged by cc_val()")
dat1 <- dat[flag_val, ]
nrow(dat); nrow(dat1)
# ensure 'flag_val' is a logical vector, not a data.frame
if (is.data.frame(flag_val) || inherits(flag_val, "tbl_df")) {
flag_val <- flag_val[[1]]
}
flag_val <- as.logical(flag_val)
plot_flags <- function(data, flagged, title) {
# flagged: logical vector, TRUE = problematic record
data_flagged <- data[flagged, ]
data_kept    <- data[!flagged, ]
world_map <- borders("world", colour = "gray70", fill = "gray90")
ggplot() +
world_map +
coord_fixed() +
geom_point(
data = data_kept,
aes(lon, lat),
color = "darkgreen",
size = 0.6,
alpha = 0.7
) +
geom_point(
data = data_flagged,
aes(lon, lat),
color = "red",
size = 0.8,
alpha = 0.8
) +
labs(
title = title,
subtitle = "Green = kept, Red = flagged"
) +
theme_bw()
}
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
value   = "flagged",
verbose = FALSE
)
flag_val <- as.logical(flag_val)
n_total   <- length(flag_val)
n_flagged <- sum(flag_val, na.rm = TRUE)
n_kept    <- n_total - n_flagged
cat("Total records:", n_total, "\n")
cat("Kept (valid coordinates):", n_kept, "\n")
cat("Flagged (invalid coordinates):", n_flagged, "\n")
flag_val <- cc_val(
x = dat,
lon = "lon",
lat = "lat",
value   = "flagged",
verbose = FALSE
)
flag_val <- as.logical(flag_val)
n_total   <- length(flag_val)
n_flagged <- sum(flag_val, na.rm = TRUE)
n_kept    <- n_total - n_flagged
cat("Total records:", n_total, "\n")
cat("Kept (valid coordinates):", n_kept, "\n")
cat("Flagged (invalid coordinates):", n_flagged, "\n")
cl <- cc_val(dat, lat = "lat", lon = "lng")
cl <- cc_val(dat_raw, lat = "lat", lon = "lng")
cl <- cc_val(dat_raw, lat = "lat", lon = "lon")
cl <- cc_val(dat_raw, lat = "lat", lon = "lon")
library(dplyr)
library(ggplot2)
library(CoordinateCleaner)
library(countrycode)
library(paleobioDB)
install.packages("paleobioDB")
library(paleobioDB)
#load data
dat <- paleobioDB::pbdb_occurrences(base_name = "Magnoliopsida",
vocab = "pbdb", limit = 5000,
show = c("coords", "phylo", "attr", "loc", "time", "rem"))
dat <- dat %>% mutate(lng = as.numeric(lng),
lat = as.numeric(lat),
early_age = as.numeric(early_age),
late_age = as.numeric(late_age))
View(dat)
dat <- dat %>% mutate(lng = as.numeric(lng),
lat = as.numeric(lat))
rownames(dat) <- NULL
cl <- cc_val(dat, lat = "lat", lon = "lng")
str(dat_raw[, c("lon", "lat")])
View(dat_raw)
dat <- dat_raw %>%
dplyr::select(
species,
decimalLongitude,
decimalLatitude,
countryCode,
year,
basisOfRecord,
individualCount,
institutionCode,
datasetName,
gbifID
) %>%
dplyr::filter(!is.na(decimalLongitude),
!is.na(decimalLatitude)) %>%
dplyr::filter(basisOfRecord == "PRESERVED_SPECIMEN") %>%
dplyr::rename(lon = decimalLongitude,
lat = decimalLatitude)
glimpse(dat)
str(dat[, c("lon", "lat")])
summary(dat[, c("lon", "lat")])
range(dat$lon, na.rm = TRUE)
range(dat$lat, na.rm = TRUE)
dat <- dat %>%
mutate(
lon = as.numeric(lon),
lat = as.numeric(lat)
)
str(dat[, c("lon", "lat")])
dat_test <- dat[1:200, ]
cl_test <- cc_val(
x = dat_test,
lon = "lon",
lat = "lat",
value   = "flagged",
verbose = TRUE
)
cl_test <- as.logical(cl_test)
table(cl_test, useNA = "ifany")
cl <- cc_val(dat_raw, lat = "lat", lon = "lon")
cl <- cc_val(dat, lat = "lat", lon = "lon")
flag_val <- cc_val(
x       = dat,
lon     = "lon",
lat     = "lat",
value   = "flagged",  # TRUE = problematic, FALSE = kept
verbose = FALSE
)
n_total   <- length(flag_val)
n_flagged <- sum(flag_val, na.rm = TRUE)
n_kept    <- n_total - n_flagged
cat("Total records:", n_total, "\n")
cat("Kept (valid coordinates):", n_kept, "\n")
cat("Flagged (invalid coordinates):", n_flagged, "\n")
flag_val <- cc_val(
x       = dat,
lon     = "lon",
lat     = "lat",
value   = "flagged",  # TRUE = problematic, FALSE = kept
# verbose = FALSE
)
plot_flags(dat, flag_val, "Invalid coordinates flagged by cc_val()")
